<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OTT Navigator â€” Enhanced Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.1/dist/hls.min.js"></script>
  <style>
    :root{
      --bg:#071022;--card:#0b1220;--muted:#9aa4b2;--accent:#22c1c3;
      --accent-hover:#1da8aa;--error:#ff4757;--success:#2ed573;
    }
    *{box-sizing:border-box;font-family:Inter,Arial,Helvetica,sans-serif}
    body{
      margin:0;
      background:linear-gradient(180deg,#071021 0%,#081428 100%);
      color:#e6eef6;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }
    header{padding:12px;background:transparent}
    .brand{
      font-weight:700;
      font-size:18px;
      background:linear-gradient(135deg,var(--accent),#4facfe);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      margin-bottom:12px;
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand-left{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .status-badge{
      font-size:11px;
      padding:3px 8px;
      border-radius:12px;
      background:rgba(34,193,195,0.15);
      color:var(--accent);
      font-weight:600;
    }
    .video-box{
      background:#000;
      border-radius:12px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 8px 32px rgba(0,0,0,0.4);
      position:relative;
    }
    video{width:100%;height:60vh;background:#000}
    .video-overlay{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,0.7);
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:12px;
      opacity:0;
      pointer-events:none;
      transition:opacity 0.3s;
    }
    .video-overlay.active{opacity:1;pointer-events:all}
    .spinner{
      width:40px;
      height:40px;
      border:3px solid rgba(255,255,255,0.1);
      border-top-color:var(--accent);
      border-radius:50%;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    main{flex:1;padding:12px}
    .controls{
      display:flex;
      gap:12px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .btn{
      padding:8px 16px;
      border-radius:8px;
      border:none;
      background:var(--accent);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
    }
    .btn:hover{background:var(--accent-hover);transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-secondary{background:rgba(255,255,255,0.05)}
    .btn-secondary:hover{background:rgba(255,255,255,0.1)}
    input,select{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(255,255,255,0.03);
      color:inherit;
      transition:all 0.2s;
    }
    input:focus,select:focus{
      outline:none;
      border-color:var(--accent);
      background:rgba(255,255,255,0.05);
    }
    .input-group{flex:1;min-width:200px}
    .input-group label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
      font-weight:500;
    }
    footer{
      background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);
      padding:12px;
      border-top:1px solid rgba(255,255,255,0.05);
    }
    .search-box{
      position:relative;
      margin-bottom:12px;
    }
    .search-box input{width:100%}
    .filter-row{
      display:flex;
      gap:8px;
      margin-bottom:12px;
      align-items:center;
    }
    .filter-row select{flex:1}
    .channels-box{
      max-height:36vh;
      overflow:auto;
      border-radius:8px;
      padding:8px;
      background:rgba(0,0,0,0.15);
    }
    .channels-box::-webkit-scrollbar{width:8px}
    .channels-box::-webkit-scrollbar-track{background:rgba(255,255,255,0.02);border-radius:4px}
    .channels-box::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:4px}
    .channels-box::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.15)}
    .channel{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px;
      border-radius:8px;
      cursor:pointer;
      transition:all 0.2s;
      border:1px solid transparent;
    }
    .channel:hover{
      background:rgba(255,255,255,0.04);
      border-color:rgba(255,255,255,0.08);
      transform:translateX(2px);
    }
    .channel.playing{
      background:rgba(34,193,195,0.1);
      border-color:var(--accent);
    }
    .logo{
      width:64px;
      height:40px;
      flex:0 0 64px;
      border-radius:6px;
      object-fit:cover;
      background:#06111a;
      border:1px solid rgba(255,255,255,0.05);
    }
    .meta{flex:1}
    .title{font-weight:600;margin-bottom:2px}
    .epg{font-size:12px;color:var(--muted)}
    .channel-count{
      display:inline-block;
      padding:4px 10px;
      background:rgba(255,255,255,0.05);
      border-radius:12px;
      font-size:12px;
      font-weight:600;
      color:var(--accent);
    }
    .small{font-size:13px;color:var(--muted);line-height:1.6}
    .stats{
      display:flex;
      gap:16px;
      margin-top:8px;
      font-size:12px;
    }
    .stat-item{
      color:var(--muted);
    }
    .stat-value{
      color:var(--accent);
      font-weight:600;
    }
    .empty-state{
      text-align:center;
      padding:40px 20px;
      color:var(--muted);
    }
    @media (max-width:900px){
      video{height:40vh}
      .channels-box{max-height:30vh}
      .controls{flex-direction:column}
      .input-group{min-width:100%}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      OTT Navigator â€” Enhanced Player
      <span class="status-badge" id="status">Ready</span>
    </div>
    <div class="video-box">
      <video id="video" controls playsinline muted></video>
      <div class="video-overlay" id="overlay">
        <div class="spinner"></div>
        <div class="small">Loading stream...</div>
      </div>
    </div>
  </header>

  <main>
    <div class="stats">
      <div class="stat-item">Channels: <span class="stat-value" id="channelCount">0</span></div>
      <div class="stat-item">Groups: <span class="stat-value" id="groupCount">0</span></div>
      <div class="stat-item">Playing: <span class="stat-value" id="nowPlaying">â€”</span></div>
    </div>
  </main>
  
  <!-- Hidden playlist URL -->
  <input type="hidden" id="playlistUrl" value="https://rkdyiptv-m3u.pages.dev/Playlist/Test.m3u" />

  <footer>
    <div class="search-box">
      <input id="search" placeholder="ðŸ” Search channels..." />
    </div>
    <div class="filter-row">
      <select id="groupFilter">
        <option value="">All Groups</option>
      </select>
      <span class="channel-count" id="visibleCount">0 channels</span>
    </div>
    <div class="channels-box" id="channels"></div>
  </footer>

<script>
const listEl = document.getElementById('channels');
const playlistUrl = document.getElementById('playlistUrl');
const video = document.getElementById('video');
const searchInput = document.getElementById('search');
const groupFilter = document.getElementById('groupFilter');
const statusBadge = document.getElementById('status');
const overlay = document.getElementById('overlay');
const channelCount = document.getElementById('channelCount');
const groupCount = document.getElementById('groupCount');
const nowPlaying = document.getElementById('nowPlaying');
const visibleCount = document.getElementById('visibleCount');

let channels = [];
let filteredChannels = [];
let currentIndex = -1;

function parseM3U(txt){
  const lines = txt.split(/\r?\n/);
  const out=[]; let info=null;
  for(let i=0;i<lines.length;i++){
    const line = lines[i].trim();
    if(!line) continue;
    if(line.startsWith('#EXTINF')){
      info = {raw:line};
      const attrs = {};
      const commaIdx = line.indexOf(',');
      const attrPart = commaIdx>0 ? line.substring(8, commaIdx) : line.substring(8);
      const attrMatches = attrPart.match(/(\w[\w-]*)\s*=\s*"([^"]*)"/g);
      if(attrMatches){
        attrMatches.forEach(a=>{
          const m = a.match(/(\w[\w-]*)\s*=\s*"([^"]*)"/);
          if(m) attrs[m[1]] = m[2];
        });
      }
      info.tvg = attrs['tvg-id'] || attrs['tvg-name'] || '';
      info.logo = attrs['tvg-logo'] || '';
      info.group = attrs['group-title'] || 'Uncategorized';
      info.title = (commaIdx>-1)? line.substring(commaIdx+1).trim() : 'Untitled';
    } else if(!line.startsWith('#')){
      if(info){ info.url = line; out.push(info); info=null; }
    }
  }
  return out;
}

function updateStats(){
  channelCount.textContent = channels.length;
  const groups = new Set(channels.map(ch => ch.group));
  groupCount.textContent = groups.size;
  visibleCount.textContent = `${filteredChannels.length} channel${filteredChannels.length !== 1 ? 's' : ''}`;
}

function updateGroupFilter(){
  const groups = [...new Set(channels.map(ch => ch.group))].sort();
  groupFilter.innerHTML = '<option value="">All Groups</option>';
  groups.forEach(g => {
    const opt = document.createElement('option');
    opt.value = g;
    opt.textContent = `${g} (${channels.filter(ch => ch.group === g).length})`;
    groupFilter.appendChild(opt);
  });
}

function applyFilters(){
  const search = searchInput.value.toLowerCase().trim();
  const group = groupFilter.value;
  
  filteredChannels = channels.filter(ch => {
    const matchSearch = !search || 
      ch.title.toLowerCase().includes(search) || 
      ch.tvg.toLowerCase().includes(search) ||
      ch.group.toLowerCase().includes(search);
    const matchGroup = !group || ch.group === group;
    return matchSearch && matchGroup;
  });
  
  render();
  updateStats();
}

function render(){
  if(filteredChannels.length === 0){
    listEl.innerHTML = '<div class="empty-state">No channels found. Try adjusting your filters.</div>';
    return;
  }
  
  listEl.innerHTML='';
  filteredChannels.forEach((ch, idx)=>{
    const originalIdx = channels.indexOf(ch);
    const el = document.createElement('div');
    el.className = 'channel' + (currentIndex === originalIdx ? ' playing' : '');
    
    const img = document.createElement('img');
    img.className='logo';
    img.src = ch.logo || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="100"><rect width="100%" height="100%" fill="%23061218"/></svg>';
    img.onerror = ()=>{ img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="100"><rect width="100%" height="100%" fill="%23061218"/></svg>'; }
    
    const meta = document.createElement('div');
    meta.className='meta';
    meta.innerHTML = '<div class="title">' + escapeHtml(ch.title) + '</div><div class="epg">EPG: ' + escapeHtml(ch.tvg || 'â€”') + ' â€¢ ' + escapeHtml(ch.group) + '</div>';
    
    el.appendChild(img);
    el.appendChild(meta);
    el.onclick = ()=>play(originalIdx);
    listEl.appendChild(el);
  });
}

function escapeHtml(s){ 
  return String(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); 
}

async function loadFromUrl(url){
  try{
    statusBadge.textContent = 'Loading...';
    statusBadge.style.background = 'rgba(255,193,7,0.15)';
    statusBadge.style.color = '#ffc107';
    
    const res = await fetch(url);
    if(!res.ok) throw new Error('Fetch failed');
    const txt = await res.text();
    channels = parseM3U(txt);
    
    updateGroupFilter();
    applyFilters();
    
    statusBadge.textContent = 'Loaded';
    statusBadge.style.background = 'rgba(46,213,115,0.15)';
    statusBadge.style.color = '#2ed573';
    
    setTimeout(() => {
      statusBadge.textContent = 'Ready';
      statusBadge.style.background = 'rgba(34,193,195,0.15)';
      statusBadge.style.color = '#22c1c3';
    }, 2000);
  }catch(e){
    console.error('Failed to load playlist:', e);
    statusBadge.textContent = 'Retry...';
    statusBadge.style.background = 'rgba(255,193,7,0.15)';
    statusBadge.style.color = '#ffc107';
    // Silently retry after 5 seconds
    setTimeout(() => loadFromUrl(url), 5000);
  }
}

function showOverlay(){
  overlay.classList.add('active');
}

function hideOverlay(){
  overlay.classList.remove('active');
}

function play(index){
  currentIndex = index;
  const ch = channels[index];
  const url = ch.url;
  
  if(!url){
    console.warn('No URL for channel:', ch.title);
    return;
  }
  
  nowPlaying.textContent = ch.title;
  showOverlay();
  
  // Clean up previous player
  if(window._hls) { 
    try{ 
      window._hls.destroy(); 
      window._hls = null;
    }catch(e){
      console.error('Error destroying HLS:', e);
    } 
  }
  
  // Detect stream type
  const urlLower = url.toLowerCase();
  const isHLS = urlLower.includes('.m3u8') || urlLower.includes('m3u8');
  const isMPD = urlLower.includes('.mpd') || urlLower.includes('dash');
  const isRTMP = url.startsWith('rtmp://') || url.startsWith('rtmps://');
  const isRTSP = url.startsWith('rtsp://');
  const isYouTube = urlLower.includes('youtube.com') || urlLower.includes('youtu.be');
  const isMP4 = urlLower.includes('.mp4');
  const isWebM = urlLower.includes('.webm');
  const isMKV = urlLower.includes('.mkv');
  const isAVI = urlLower.includes('.avi');
  const isFLV = urlLower.includes('.flv');
  const isTS = urlLower.includes('.ts');
  const isAAC = urlLower.includes('.aac') || urlLower.includes('.m4a');
  const isMP3 = urlLower.includes('.mp3');
  const isOGG = urlLower.includes('.ogg');
  
  console.log('Stream type detection:', {
    url,
    isHLS, isMPD, isRTMP, isRTSP, isYouTube
  });
  
  // HLS Streams (.m3u8)
  if(isHLS){
    if(Hls.isSupported()){
      const hls = new Hls({
        enableWorker: true,
        lowLatencyMode: true,
        backBufferLength: 90,
        maxBufferLength: 30,
        maxMaxBufferLength: 600,
        manifestLoadingTimeOut: 10000,
        manifestLoadingMaxRetry: 4,
        levelLoadingTimeOut: 10000,
        fragLoadingTimeOut: 20000
      });
      window._hls = hls;
      hls.loadSource(url);
      hls.attachMedia(video);
      
      hls.on(Hls.Events.MANIFEST_PARSED, ()=>{ 
        // Try to play with sound first
        video.muted = false;
        video.play().then(()=>{
          hideOverlay();
          console.log('Playing HLS with sound:', ch.title);
        }).catch((err)=>{ 
          console.log('Play with sound blocked, trying muted:', err);
          // Fallback to muted autoplay
          video.muted = true;
          video.play().then(()=>{
            hideOverlay();
            console.log('Playing HLS muted:', ch.title);
          }).catch(e => {
            hideOverlay();
            console.error('All play attempts failed:', e);
          });
        }); 
      });
      
      hls.on(Hls.Events.ERROR, (event, data) => {
        console.error('HLS Error:', data.type, data.details, data);
        
        if(data.fatal){
          switch(data.type){
            case Hls.ErrorTypes.NETWORK_ERROR:
              console.log('Network error, trying to recover...');
              hls.startLoad();
              setTimeout(hideOverlay, 3000);
              break;
            case Hls.ErrorTypes.MEDIA_ERROR:
              console.log('Media error, trying to recover...');
              hls.recoverMediaError();
              setTimeout(hideOverlay, 3000);
              break;
            default:
              console.error('Fatal error, cannot recover');
              hideOverlay();
              break;
          }
        }
      });
    }else if(video.canPlayType('application/vnd.apple.mpegurl')){
      // Native HLS support (Safari/iOS)
      video.src = url;
      video.load();
      video.muted = false;
      video.play().then(()=>{
        hideOverlay();
        console.log('Playing HLS (native) with sound:', ch.title);
      }).catch((err)=>{ 
        console.log('Native play with sound blocked, trying muted:', err);
        video.muted = true;
        video.play().then(()=>{
          hideOverlay();
          console.log('Playing HLS (native) muted:', ch.title);
        }).catch(e => {
          hideOverlay();
          console.error('Native HLS play failed:', e);
        });
      });
    }else{
      hideOverlay();
      console.error('HLS not supported in this browser');
    }
  }
  // MPEG-DASH Streams (.mpd)
  else if(isMPD){
    console.log('DASH stream detected. Note: Native DASH support limited. Consider using dash.js library.');
    video.src = url;
    video.load();
    video.muted = false;
    video.play().then(()=>{
      hideOverlay();
      console.log('Playing DASH with sound:', ch.title);
    }).catch((err)=>{ 
      console.log('DASH play with sound blocked, trying muted:', err);
      video.muted = true;
      video.play().then(()=>{
        hideOverlay();
        console.log('Playing DASH muted:', ch.title);
      }).catch(e => {
        hideOverlay();
        console.error('DASH play failed:', e);
      });
    });
  }
  // RTMP/RTSP Streams
  else if(isRTMP || isRTSP){
    hideOverlay();
    console.error('RTMP/RTSP streams are not supported in modern browsers. These require Flash or special protocols.');
    console.log('Consider using HLS or DASH alternatives for:', url);
  }
  // YouTube URLs
  else if(isYouTube){
    hideOverlay();
    console.error('YouTube URLs cannot be played directly. Use YouTube embed API or extract direct stream URL.');
  }
  // Direct video files (MP4, WebM, etc.)
  else if(isMP4 || isWebM || isMKV || isAVI || isFLV || isTS){
    const mimeTypes = {
      mp4: 'video/mp4',
      webm: 'video/webm',
      mkv: 'video/x-matroska',
      avi: 'video/x-msvideo',
      flv: 'video/x-flv',
      ts: 'video/mp2t'
    };
    
    video.src = url;
    video.load();
    
    // Try to set appropriate type
    if(isMP4) video.type = mimeTypes.mp4;
    else if(isWebM) video.type = mimeTypes.webm;
    else if(isMKV) video.type = mimeTypes.mkv;
    else if(isAVI) video.type = mimeTypes.avi;
    else if(isFLV) video.type = mimeTypes.flv;
    else if(isTS) video.type = mimeTypes.ts;
    
    video.muted = false;
    video.play().then(()=>{
      hideOverlay();
      console.log('Playing direct video with sound:', ch.title);
    }).catch((err)=>{ 
      console.log('Direct video with sound blocked, trying muted:', err);
      video.muted = true;
      video.play().then(()=>{
        hideOverlay();
        console.log('Playing direct video muted:', ch.title);
      }).catch(e => {
        hideOverlay();
        console.error('Direct video play failed:', e);
      });
    });
  }
  // Audio files (MP3, AAC, OGG)
  else if(isAAC || isMP3 || isOGG){
    const mimeTypes = {
      aac: 'audio/aac',
      mp3: 'audio/mpeg',
      ogg: 'audio/ogg',
      m4a: 'audio/mp4'
    };
    
    video.src = url;
    video.load();
    
    if(isAAC) video.type = mimeTypes.aac;
    else if(isMP3) video.type = mimeTypes.mp3;
    else if(isOGG) video.type = mimeTypes.ogg;
    
    video.muted = false;
    video.play().then(()=>{
      hideOverlay();
      console.log('Playing audio:', ch.title);
    }).catch((err)=>{ 
      console.log('Audio play blocked, trying muted:', err);
      video.muted = true;
      video.play().then(()=>{
        hideOverlay();
        console.log('Playing audio muted:', ch.title);
      }).catch(e => {
        hideOverlay();
        console.error('Audio play failed:', e);
      });
    });
  }
  // Generic HTTP/HTTPS streams
  else if(/^https?:\/\//i.test(url)){
    video.src = url;
    video.load();
    video.muted = false;
    video.play().then(()=>{
      hideOverlay();
      console.log('Playing generic stream with sound:', ch.title);
    }).catch((err)=>{ 
      console.log('Generic stream with sound blocked, trying muted:', err);
      video.muted = true;
      video.play().then(()=>{
        hideOverlay();
        console.log('Playing generic stream muted:', ch.title);
      }).catch(e => {
        hideOverlay();
        console.error('Generic stream play failed:', e);
      });
    });
  }
  // Unsupported protocols
  else {
    hideOverlay();
    console.error('Unsupported URL protocol or format:', url);
  }
  
  render();
}

function clearVideo(){
  if(window._hls) { try{ window._hls.destroy(); }catch(e){} }
  video.src = '';
  video.load();
  currentIndex = -1;
  nowPlaying.textContent = 'â€”';
  hideOverlay();
  render();
}

// Event listeners
searchInput.addEventListener('input', applyFilters);
groupFilter.addEventListener('change', applyFilters);

video.addEventListener('waiting', showOverlay);
video.addEventListener('playing', hideOverlay);
video.addEventListener('canplay', hideOverlay);

// Auto-load and auto-reload playlist
let reloadInterval;
window.addEventListener('load', ()=>{
  const defaultUrl = playlistUrl.value.trim();
  if(defaultUrl){
    loadFromUrl(defaultUrl);
    // Auto reload playlist every 30 minutes to refresh channel list
    reloadInterval = setInterval(()=>{
      loadFromUrl(defaultUrl);
    }, 30 * 60 * 1000);
  }
});
</script>
</body>
</html>
